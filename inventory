var SpreadSheetID = "1ZfSkVgSC8NrhLRy-F24JHcnvCvLn3YRlocpqI8KQNpI"
var SheetName = "Media/Serum Summary"
var EmailSheet = "emails"

// https://blog.devgenius.io/send-mass-emails-using-google-apps-script-from-a-google-spreadsheet-fc2f79c9febd
function getMediaInventory(media){
  var jo = {};
  var dataArray = [];
// collecting data from 2nd Row , 1st column to last row and last    // column sheet.getLastRow()-1
var rows = media.getRange(2,1,media.getLastRow()-1, media.getLastColumn()).getValues();
for(var i = 0, l= rows.length; i<l ; i++){
    var dataRow = rows[i];
    var record = {};
    record['item'] = dataRow[0];
    record['volume'] = dataRow[1];
    record['total'] = dataRow[2];
    record['order now'] = dataRow[3];
    dataArray.push(record);
  }
  jo = dataArray;
return jo;
}

function getEmails(email_sheet){
  var jo = {};
  var dataArray = [];
// collecting data from 2nd Row , 1st column to last row and last    // column sheet.getLastRow()-1
var rows = email_sheet.getRange(2,1,email_sheet.getLastRow()-1, email_sheet.getLastColumn()).getValues();
for(var i = 0, l= rows.length; i<l ; i++){
    var dataRow = rows[i];
    var record = {};
    record['email'] = dataRow[0];
    dataArray.push(record);
  }
  jo = dataArray;
return jo;
}

function sendMail(e){

  // inventory
  var ss = SpreadsheetApp.openById(SpreadSheetID);
  var sheet = ss.getSheetByName(SheetName);
  var inventory = getMediaInventory(sheet);

  //email stuff
  var emailInfo = ss.getSheetByName(EmailSheet);
  var email_json = getEmails(emailInfo);

  for (var i=0; i<inventory.length; i++){
    if (inventory[i]['total'] <= inventory[i]['order now']){
      for (var j=0; j<email_json.length; j++){
        item_to_order = inventory[i]['item']
        num_left = inventory[i]['total']
        MailApp.sendEmail({to: email_json[j].email, subject: item_to_order, htmlBody: num_left + " bottles of" + item_to_order + "left.", noReply:true})
      }
    }
  }


}
  
